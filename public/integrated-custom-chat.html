<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Marketing Intelligence - Custom Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066ff;
            --primary-dark: #0052cc;
            --dark: #0a0a0a;
            --dark-card: #141414;
            --border: #262626;
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Layout principale come deep-marketing-chat.html */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--dark-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            height: 32px;
            margin-bottom: 1rem;
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            align-self: flex-start;
            background: #1a1a1a;
            border: 1px solid var(--border);
        }

        .message.assistant.streaming::after {
            content: '‚óè‚óè‚óè';
            display: inline-block;
            margin-left: 8px;
            color: var(--primary);
            font-size: 8px;
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '‚óè'; }
            40% { content: '‚óè‚óè'; }
            60%, 100% { content: '‚óè‚óè‚óè'; }
        }

        /* Input area */
        .chat-input-container {
            padding: 1.5rem;
            background: var(--dark-card);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: var(--dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            resize: none;
            outline: none;
            min-height: 44px;
            max-height: 120px;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .send-button {
            width: 44px;
            height: 44px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main content area */
        .main-panel {
            flex: 1;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-header {
            padding: 1.5rem 2rem;
            background: var(--dark-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Dashboard cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--dark-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0.5rem 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Results section */
        .results-section {
            background: var(--dark-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .results-section h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .result-card {
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .result-card:hover {
            border-color: var(--primary);
        }

        /* Loading states */
        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            background: #1a1a1a;
            border: 1px solid var(--border);
            border-radius: 12px;
            align-self: flex-start;
            max-width: 70%;
        }

        .typing-indicator.show {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Markdown styles */
        .message h1, .message h2, .message h3, .message h4 {
            margin: 0.75rem 0 0.5rem 0;
            color: var(--text-primary);
        }

        .message ul, .message ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .message li {
            margin: 0.25rem 0;
        }

        .message code {
            background: var(--dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message pre {
            background: var(--dark);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .message strong {
            color: var(--primary);
            font-weight: 600;
        }

        /* Welcome message */
        .welcome-message {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .welcome-message h2 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .quick-action {
            padding: 0.5rem 1rem;
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .quick-action:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        /* Status indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--dark);
            border-radius: 20px;
            font-size: 0.75rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 60vh;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            
            .main-panel {
                height: 40vh;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar with Chat -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="https://app.drivenmetrics.com/assets/images/logo/logo-text-on-dark-cropped.svg" 
                     alt="Drivenmetrics" class="logo">
                <h3>Marketing Intelligence Chat</h3>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">
                        <h2>üëã Benvenuto!</h2>
                        <p>Sono il tuo assistente di marketing intelligence. Posso aiutarti ad analizzare:</p>
                        <div class="quick-actions">
                            <div class="quick-action" onclick="sendQuickMessage('Analizza il mercato delle scarpe sportive')">
                                üëü Scarpe sportive
                            </div>
                            <div class="quick-action" onclick="sendQuickMessage('Mostrami i competitor di Nike')">
                                üèÜ Competitor Nike
                            </div>
                            <div class="quick-action" onclick="sendQuickMessage('Trend marketing digitale 2025')">
                                üìà Trend 2025
                            </div>
                            <div class="quick-action" onclick="sendQuickMessage('Analisi Facebook Ads del settore moda')">
                                üëó Settore moda
                            </div>
                        </div>
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>

                <div class="chat-input-container">
                    <div class="input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Chiedi qualcosa sul marketing..."
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="sendButton" onclick="sendMessage()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Panel -->
        <main class="main-panel">
            <div class="main-header">
                <h2>üìä Dashboard Analisi</h2>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="connectionStatus">Connesso</span>
                </div>
            </div>

            <div class="main-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Annunci Analizzati</div>
                        <div class="stat-value" id="adsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Brand Identificati</div>
                        <div class="stat-value" id="brandsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Query Eseguite</div>
                        <div class="stat-value" id="queriesCount">0</div>
                    </div>
                </div>

                <div class="results-section">
                    <h3>üìà Ultimi Risultati</h3>
                    <div id="resultsContainer">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            I risultati delle tue analisi appariranno qui
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration - IMPORTANTE: Inserisci qui il tuo webhook URL
        const WEBHOOK_URL = 'https://n8n.growthers.io/webhook/21b75195-84e4-4e1b-8350-166b0b223a12/chat';
        const SESSION_ID = 'session-' + Date.now();
        const ENABLE_STREAMING = true;

        // Get user info from cookies or session
        function getUserInfo() {
            // Prova a ottenere info dall'utente loggato
            const sessionCookie = getCookie('session_id');
            const userEmail = getCookie('user_email') || localStorage.getItem('userEmail');
            
            return {
                sessionId: sessionCookie || SESSION_ID,
                userEmail: userEmail || 'anonymous@drivenmetrics.com',
                userId: localStorage.getItem('userId') || 'user-' + Date.now()
            };
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Stats management
        let stats = {
            adsCount: 0,
            brandsCount: 0,
            queriesCount: 0
        };

        // Auto-resize textarea
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Enter key handler
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Format markdown
        function formatMarkdown(text) {
            if (!text) return '';
            
            let formatted = text;
            
            // Headers
            formatted = formatted.replace(/^#### (.*?)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
            
            // Bold and italic
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Code
            formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Lists
            formatted = formatted.replace(/^[\*\-] (.*?)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*?<\/li>\s*)+/gs, '<ul>$1</ul>');
            
            // Line breaks
            if (!formatted.includes('<')) {
                formatted = formatted.replace(/\n\n/g, '</p><p>');
                formatted = '<p>' + formatted + '</p>';
            }
            
            return formatted;
        }

        // Add message to chat
        function addMessage(role, content, messageId = null) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Remove welcome message if exists
            const welcome = messagesContainer.querySelector('.welcome-message');
            if (welcome) welcome.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            if (messageId) messageDiv.id = messageId;
            
            if (role === 'assistant') {
                messageDiv.innerHTML = formatMarkdown(content);
            } else {
                messageDiv.textContent = content;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv;
        }

        // Show/hide typing indicator
        function showTyping(show = true) {
            const indicator = document.getElementById('typingIndicator');
            if (show) {
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
        }

        // Update stats
        function updateStats(data) {
            if (data.adsCount !== undefined) {
                stats.adsCount = data.adsCount;
                animateValue('adsCount', data.adsCount);
            }
            if (data.brandsCount !== undefined) {
                stats.brandsCount = data.brandsCount;
                animateValue('brandsCount', data.brandsCount);
            }
            if (data.queriesCount !== undefined) {
                stats.queriesCount = data.queriesCount;
                animateValue('queriesCount', data.queriesCount);
            }
        }

        // Animate counter
        function animateValue(id, value) {
            const element = document.getElementById(id);
            const start = parseInt(element.textContent) || 0;
            const duration = 1000;
            const increment = (value - start) / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= value) || (increment < 0 && current <= value)) {
                    element.textContent = value;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 16);
        }

        // Update results
        function updateResults(data) {
            const container = document.getElementById('resultsContainer');
            
            if (data.keyInsights || data.results) {
                container.innerHTML = '';
                
                // Add result card
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                resultCard.innerHTML = `
                    <h4>${data.title || 'Analisi Completata'}</h4>
                    <p>${data.summary || 'Risultati disponibili'}</p>
                    <small style="color: var(--text-secondary);">
                        ${new Date().toLocaleTimeString('it-IT')}
                    </small>
                `;
                container.appendChild(resultCard);
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage('user', message);
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            sendButton.disabled = true;
            
            // Update query count
            stats.queriesCount++;
            animateValue('queriesCount', stats.queriesCount);
            
            // Show typing
            showTyping(true);
            
            // Get user info
            const userInfo = getUserInfo();
            
            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': ENABLE_STREAMING ? 'text/event-stream, application/json' : 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: userInfo.sessionId,
                        userId: userInfo.userId,
                        userEmail: userInfo.userEmail,
                        timestamp: new Date().toISOString(),
                        metadata: {
                            source: 'integrated-chat',
                            streaming: ENABLE_STREAMING
                        }
                    })
                });
                
                showTyping(false);
                
                // Check if streaming
                const contentType = response.headers.get('content-type') || '';
                const isStreaming = ENABLE_STREAMING && contentType.includes('text/event-stream');
                
                if (isStreaming) {
                    await handleStreamingResponse(response);
                } else {
                    await handleJsonResponse(response);
                }
                
            } catch (error) {
                console.error('Error:', error);
                showTyping(false);
                addMessage('assistant', `‚ùå Errore di connessione. Riprova tra poco.`);
            } finally {
                sendButton.disabled = false;
                input.focus();
            }
        }

        // Handle JSON response
        async function handleJsonResponse(response) {
            const data = await response.json();
            console.log('Response:', data);
            
            // Extract message
            const message = data.output || data.response || data.message || data.text || JSON.stringify(data);
            addMessage('assistant', message);
            
            // Update stats if available
            if (data.stats) updateStats(data.stats);
            if (data.results) updateResults(data);
        }

        // Handle streaming response
        async function handleStreamingResponse(response) {
            const messageId = 'stream-' + Date.now();
            const messageDiv = addMessage('assistant', '', messageId);
            messageDiv.classList.add('streaming');
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullContent = '';
            
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        
                        // Parse SSE or JSON
                        let data;
                        if (line.startsWith('data: ')) {
                            try {
                                data = JSON.parse(line.slice(6));
                            } catch (e) {
                                continue;
                            }
                        } else if (line.startsWith('{')) {
                            try {
                                data = JSON.parse(line);
                            } catch (e) {
                                continue;
                            }
                        }
                        
                        if (data && data.content) {
                            fullContent += data.content;
                            messageDiv.innerHTML = formatMarkdown(fullContent);
                            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        // Update stats if provided
                        if (data && data.stats) updateStats(data.stats);
                    }
                }
            } finally {
                messageDiv.classList.remove('streaming');
            }
        }

        // Quick actions
        function sendQuickMessage(text) {
            document.getElementById('chatInput').value = text;
            sendMessage();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Update connection status
            const updateStatus = () => {
                const statusEl = document.getElementById('connectionStatus');
                if (navigator.onLine) {
                    statusEl.textContent = 'Connesso';
                    document.querySelector('.status-dot').style.background = '#4ade80';
                } else {
                    statusEl.textContent = 'Offline';
                    document.querySelector('.status-dot').style.background = '#ef4444';
                }
            };
            
            window.addEventListener('online', updateStatus);
            window.addEventListener('offline', updateStatus);
            updateStatus();
        });
    </script>
</body>
</html>